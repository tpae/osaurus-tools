name: Validate Plugins

on:
  push:
    branches: [master, main]
    paths:
      - "plugins/**"
      - "scripts/validate.py"
  pull_request:
    branches: [master, main]
    paths:
      - "plugins/**"
      - "scripts/validate.py"

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for base branch comparison

      - name: Fetch base branch
        if: github.event_name == 'pull_request'
        run: git fetch origin ${{ github.base_ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minisign
        run: |
          sudo apt-get update
          sudo apt-get install -y minisign

      - name: Validate plugin manifests
        env:
          VERIFY_SIGNATURES: "true"
          GITHUB_BASE_REF: ${{ github.base_ref }}
        run: python scripts/validate.py

  build-check:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build all plugins
        run: |
          for tool in time git browser fetch search; do
            echo "Building $tool..."
            cd tools/$tool
            swift build -c release
            cd ../..
          done
